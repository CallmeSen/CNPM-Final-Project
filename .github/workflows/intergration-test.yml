name: Intergration Test

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
      - '.github/workflows/intergration-test.yml'
  pull_request:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
  workflow_run:
    workflows:
      - backend-ci
    types:
      - completed

jobs:
  intergration-test:
    name: Integration Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download all build artifacts
        uses: actions/download-artifact@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Run integration tests (self-hosted, parallel)
        shell: powershell
        run: |
          Write-Host "== Integration test runner started on self-hosted runner =="

          # Ensure Docker is available (optional)
          try {
            docker version --format '{{.Server.Version}}' 2>$null
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Docker daemon not reachable" -ForegroundColor Yellow
            }
          } catch {
            Write-Host "Docker not available" -ForegroundColor Yellow
          }

          $services = @(
            @{ name = 'auth-service'; path = 'backend/auth-service' },
            @{ name = 'restaurant-service'; path = 'backend/restaurant-service' },
            @{ name = 'order-service'; path = 'backend/order-service' },
            @{ name = 'payment-service'; path = 'backend/payment-service' }
          )

          $jobs = @()
          $failed = $false

          foreach ($svc in $services) {
            $svcPath = $svc.path
            $svcName = $svc.name

            if (-not (Test-Path $svcPath)) {
              Write-Host "Skipping $svcName - path not found: $svcPath"
              continue
            }

            if (-not (Test-Path "$svcPath/package.json")) {
              Write-Host "Skipping $svcName - package.json not found"
              continue
            }

            Write-Host "Preparing $svcName tests..."

            # Detect test command
            $pkg = Get-Content "$svcPath/package.json" -Raw | ConvertFrom-Json
            if ($pkg.scripts.'test:integration') {
              $testCmd = 'npm run test:integration --silent'
            } elseif ($pkg.scripts.test) {
              $testCmd = 'npm test -- --runInBand --silent'
            } else {
              Write-Host "No test script found for $svcName - skipping"
              continue
            }

            # Start background job
            $outFile = Join-Path $PWD "$svcName.out.log"
            $errFile = Join-Path $PWD "$svcName.err.log"
            Write-Host "Starting $svcName..."
            
            $job = Start-Job -ScriptBlock {
              param($path, $cmd, $outFile, $errFile)
              Set-Location $path
              npm ci --silent 2>&1 | Out-File $outFile -Append
              Invoke-Expression $cmd 2>&1 | Out-File $outFile -Append
              $LASTEXITCODE
            } -ArgumentList $svcPath, $testCmd, $outFile, $errFile

            $jobs += @{ Name = $svcName; Job = $job; Out = $outFile; Err = $errFile }
          }

          if ($jobs.Count -eq 0) {
            Write-Host "No integration test suites found to run." -ForegroundColor Yellow
          } else {
            # Wait for all jobs
            foreach ($jobInfo in $jobs) {
              $job = $jobInfo.Job
              $name = $jobInfo.Name
              Write-Host "Waiting for $name (Job ID $($job.Id))..."
              $result = Wait-Job $job | Receive-Job
              $exitCode = if ($result) { $result } else { 0 }
              
              Write-Host "$name exited with code $exitCode"
              Write-Host "---- $name OUTPUT ----"
              if (Test-Path $jobInfo.Out) { 
                Get-Content $jobInfo.Out -Tail 200 
              } else { 
                Write-Host "(no output log)" 
              }

              Remove-Job $job

              if ($exitCode -ne 0) {
                Write-Host "$name integration tests FAILED (exit $exitCode)" -ForegroundColor Red
                $failed = $true
              } else {
                Write-Host "$name integration tests passed" -ForegroundColor Green
              }
            }
          }

          if ($failed) {
            Write-Host "One or more integration test suites failed." -ForegroundColor Red
            exit 1
          }

          Write-Host "Integration tests completed successfully." -ForegroundColor Green
