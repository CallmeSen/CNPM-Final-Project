name: Intergration Test

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
      - '.github/workflows/intergration-test.yml'
  pull_request:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
  workflow_run:
    workflows:
      - backend-ci
    types:
      - completed

jobs:
  intergration-test:
    name: Integration Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download all build artifacts
        uses: actions/download-artifact@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Run integration tests (self-hosted, parallel)
        shell: bash
        run: |
          echo "== Integration test runner started on self-hosted runner =="

          # Ensure Docker is available (optional)
          docker version --format '{{.Server.Version}}' 2>/dev/null || echo "Docker daemon not reachable"

          services=(
            "auth-service:backend/auth-service"
            "restaurant-service:backend/restaurant-service"
            "order-service:backend/order-service"
            "payment-service:backend/payment-service"
          )

          pids=()
          failed=0

          for svc in "${services[@]}"; do
            IFS=':' read -r name path <<< "$svc"

            if [[ ! -d "$path" ]]; then
              echo "Skipping $name — path not found: $path"
              continue
            fi

            if [[ ! -f "$path/package.json" ]]; then
              echo "Skipping $name — package.json not found in $path"
              continue
            fi

            echo "Preparing $name tests..."

            # Detect test command
            if grep -q '"test:integration"' "$path/package.json"; then
              testCmd="npm run test:integration --silent"
            elif grep -q '"test"' "$path/package.json"; then
              testCmd="npm test -- --runInBand --silent"
            else
              echo "No test script found for $name — skipping"
              continue
            fi

            # Start background process
            outFile="${name}.out.log"
            errFile="${name}.err.log"
            echo "Starting $name: cd $path && npm ci --silent && $testCmd"
            (cd "$path" && npm ci --silent && eval "$testCmd") > "$outFile" 2> "$errFile" &
            pids+=("$!:$name:$outFile:$errFile")
          done

          if [[ ${#pids[@]} -eq 0 ]]; then
            echo "No integration test suites found to run."
          else
            # Wait for all processes
            for pid_info in "${pids[@]}"; do
              IFS=':' read -r pid name outFile errFile <<< "$pid_info"
              echo "Waiting for $name (PID $pid)..."
              wait "$pid"
              exit_code=$?
              echo "$name exited with code $exit_code"
              echo "---- $name STDOUT ----"
              [[ -f "$outFile" ]] && tail -200 "$outFile" || echo "(no stdout log)"
              echo "---- $name STDERR ----"
              [[ -f "$errFile" ]] && tail -200 "$errFile" || echo "(no stderr log)"

              if [[ $exit_code -ne 0 ]]; then
                echo "$name integration tests FAILED (exit $exit_code)"
                failed=1
              else
                echo "$name integration tests passed"
              fi
            done
          fi

          if [[ $failed -ne 0 ]]; then
            echo "One or more integration test suites failed."
            exit 1
          fi

          echo "Integration tests completed successfully."
