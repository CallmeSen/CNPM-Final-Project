name: Intergration Test

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
  pull_request:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
  workflow_run:
    workflows:
      - backend-ci
    types:
      - completed

jobs:
  intergration-test:
    name: Integration Test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download all build artifacts
        uses: actions/download-artifact@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Run integration tests (self-hosted, parallel)
        shell: pwsh
        run: |
          Write-Host "== Integration test runner started on self-hosted runner =="

          # Ensure Docker is available (optional)
          docker version --format '{{.Server.Version}}' 2>$null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Docker daemon not reachable. Ensure Docker is available on the runner." -ForegroundColor Yellow
          }

          $services = @(
            @{ name = 'auth-service'; path = 'backend/auth-service' },
            @{ name = 'restaurant-service'; path = 'backend/restaurant-service' },
            @{ name = 'order-service'; path = 'backend/order-service' },
            @{ name = 'payment-service'; path = 'backend/payment-service' }
          )

          $processInfos = @()
          $failed = $false

          foreach ($svc in $services) {
            $svcPath = $svc.path
            $svcName = $svc.name

            if (-not (Test-Path $svcPath)) {
              Write-Host "Skipping $svcName — path not found: $svcPath"
              continue
            }

            $pkgFile = Join-Path $svcPath 'package.json'
            if (-not (Test-Path $pkgFile)) {
              Write-Host "Skipping $svcName — package.json not found in $svcPath"
              continue
            }

            Write-Host "Preparing $svcName tests..."

            # Build the command depending on presence of test:integration script
            $pkg = Get-Content $pkgFile -Raw | ConvertFrom-Json
            if ($pkg.scripts.'test:integration') {
              $testCmd = 'npm run test:integration --silent'
            } elseif ($pkg.scripts.test) {
              $testCmd = 'npm test -- --runInBand --silent'
            } else {
              Write-Host "No test script found for $svcName — skipping"
              continue
            }

            # Start a background process for each service test
            $outFile = Join-Path $PWD ("${svcName}.out.log")
            $errFile = Join-Path $PWD ("${svcName}.err.log")
            $command = "Set-Location -Path '$svcPath'; npm ci --silent; $testCmd; exit `$LASTEXITCODE"
            Write-Host "Starting $svcName: $command"
            $proc = Start-Process -FilePath pwsh -ArgumentList "-NoProfile","-Command",$command -PassThru -RedirectStandardOutput $outFile -RedirectStandardError $errFile
            $processInfos += @{ Name = $svcName; Path = $svcPath; Proc = $proc; Out = $outFile; Err = $errFile }
          }

          if ($processInfos.Count -eq 0) {
            Write-Host "No integration test suites found to run." -ForegroundColor Yellow
          } else {
            # Wait for all processes and collect results
            foreach ($info in $processInfos) {
              $proc = $info.Proc
              Write-Host "Waiting for $($info.Name) (PID $($proc.Id))..."
              Wait-Process -Id $proc.Id
              $proc.Refresh()
              $exit = $proc.ExitCode
              Write-Host "$($info.Name) exited with code $exit"
              Write-Host "---- $($info.Name) STDOUT ----"
              if (Test-Path $info.Out) { Get-Content $info.Out -Tail 200 } else { Write-Host "(no stdout log)" }
              Write-Host "---- $($info.Name) STDERR ----"
              if (Test-Path $info.Err) { Get-Content $info.Err -Tail 200 } else { Write-Host "(no stderr log)" }

              if ($exit -ne 0) {
                Write-Host "$($info.Name) integration tests FAILED (exit $exit)" -ForegroundColor Red
                $failed = $true
              } else {
                Write-Host "$($info.Name) integration tests passed" -ForegroundColor Green
              }
            }
          }


          if ($failed) {
            Write-Host "One or more integration test suites failed." -ForegroundColor Red
            exit 1
          }

          Write-Host "Integration tests completed successfully." -ForegroundColor Green
