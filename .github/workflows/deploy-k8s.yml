name: Deploy to Kubernetes

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'infra/k8s/**'
      - '.github/workflows/deploy-k8s.yml'

jobs:
  build-and-push:
    runs-on: self-hosted
    
    steps:
      - name: Clean temp directory
        shell: pwsh
        run: |
          if (Test-Path "$env:RUNNER_TEMP") {
            Get-ChildItem -Path "$env:RUNNER_TEMP" -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
        continue-on-error: true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: false

      - name: Build Backend Services
        run: |
          docker build -t auth-service:latest ./backend/auth-service
          docker build -t restaurant-service:latest ./backend/restaurant-service
          docker build -t order-service:latest ./backend/order-service
          docker build -t payment-service:latest ./backend/payment-service

      - name: Build Frontend Apps
        run: |
          docker build -t client-frontend:latest ./frontend/client
          docker build -t admin-frontend:latest ./frontend/admin
          docker build -t restaurant-frontend:latest ./frontend/restaurant

      - name: Load images to K8s (if using minikube/kind)
        run: |
          # For minikube: minikube image load <image-name>
          # For kind: kind load docker-image <image-name>
          # For Docker Desktop K8s: images already available
          echo "Images built and available in local Docker"

  deploy-to-k8s:
    needs: build-and-push
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: false
        
      - name: Set up Kubeconfig
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Debug image tags
        run: |
          echo "Backend Services:"
          echo "  - auth-service:latest"
          echo "  - restaurant-service:latest"
          echo "  - order-service:latest"
          echo "  - payment-service:latest"
          echo ""
          echo "Frontend Apps:"
          echo "  - client-frontend:latest"
          echo "  - admin-frontend:latest"
          echo "  - restaurant-frontend:latest"

      - name: Update Backend Deployments
        run: |
          kubectl set image deployment/auth-service auth-service=auth-service:latest -n cnpm-food-delivery
          kubectl set image deployment/restaurant-service restaurant-service=restaurant-service:latest -n cnpm-food-delivery
          kubectl set image deployment/order-service order-service=order-service:latest -n cnpm-food-delivery
          kubectl set image deployment/payment-service payment-service=payment-service:latest -n cnpm-food-delivery

      - name: Update Frontend Deployments
        run: |
          kubectl set image deployment/client-frontend client-frontend=client-frontend:latest -n cnpm-food-delivery
          kubectl set image deployment/admin-frontend admin-frontend=admin-frontend:latest -n cnpm-food-delivery
          kubectl set image deployment/restaurant-frontend restaurant-frontend=restaurant-frontend:latest -n cnpm-food-delivery

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/auth-service -n cnpm-food-delivery --timeout=5m
          kubectl rollout status deployment/restaurant-service -n cnpm-food-delivery --timeout=5m
          kubectl rollout status deployment/order-service -n cnpm-food-delivery --timeout=5m
          kubectl rollout status deployment/payment-service -n cnpm-food-delivery --timeout=5m
          kubectl rollout status deployment/client-frontend -n cnpm-food-delivery --timeout=5m
          kubectl rollout status deployment/admin-frontend -n cnpm-food-delivery --timeout=5m
          kubectl rollout status deployment/restaurant-frontend -n cnpm-food-delivery --timeout=5m
