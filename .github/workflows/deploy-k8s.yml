name: CI/CD Pipeline - Docker Desktop K8s

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'infra/k8s/**'
      - '.github/workflows/deploy-k8s.yml'
  workflow_dispatch:  # Cho phép trigger manual

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Chạy trên máy local với Docker Desktop

    steps:
      - name: Clean temp directory
        shell: powershell
        run: |
          if (Test-Path "$env:RUNNER_TEMP") {
            Get-ChildItem -Path "$env:RUNNER_TEMP" -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          $workDir = "E:\GitHub\actions-runner\_work\_temp"
          if (Test-Path $workDir) {
            Get-ChildItem -Path $workDir -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          echo "✓ Temp cleanup completed"
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@v3

      # 1️⃣ Đăng nhập vào DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2️⃣ Build & push Backend Services
      - name: Build and Push Auth Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/auth-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/auth-service:latest

      - name: Build and Push Restaurant Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/restaurant-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/restaurant-service:latest

      - name: Build and Push Order Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/order-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/order-service:latest

      - name: Build and Push Payment Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/payment-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/payment-service:latest

      # 2️⃣ Build & push Frontend Apps
      - name: Build and Push Client Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/client
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/client-frontend:latest

      - name: Build and Push Admin Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/admin
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/admin-frontend:latest

      - name: Build and Push Restaurant Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/restaurant
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/restaurant-frontend:latest

      # 3️⃣ Verify Docker Desktop Kubernetes
      - name: Check Kubernetes context
        run: |
          kubectl config current-context
          kubectl cluster-info
          kubectl get nodes

      # 4️⃣ Deploy to Docker Desktop Kubernetes
      - name: Prepare Namespace and Base Resources
        run: |
          # Create namespace if not exists
          kubectl create namespace cnpm-food-delivery --dry-run=client -o yaml | kubectl apply -f -
          
          # Apply base resources
          kubectl apply -f infra/k8s/namespace.yaml
          kubectl apply -f infra/k8s/secrets.yaml
          kubectl apply -f infra/k8s/pvcs.yaml

      - name: Deploy MongoDB Services
        run: |
          # Clean up existing MongoDB if exists
          kubectl delete -f infra/k8s/auth-service-mongo.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/restaurant-service-mongo.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/order-service-mongo.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/payment-service-mongo.yaml --ignore-not-found=true
          
          Start-Sleep -Seconds 10
          
          # Deploy MongoDB instances
          kubectl apply -f infra/k8s/auth-service-mongo.yaml
          kubectl apply -f infra/k8s/restaurant-service-mongo.yaml
          kubectl apply -f infra/k8s/order-service-mongo.yaml
          kubectl apply -f infra/k8s/payment-service-mongo.yaml
          
          echo "Waiting for MongoDB StatefulSets to be ready (may take 2-3 minutes)..."
          Start-Sleep -Seconds 30
          
          # Wait for StatefulSets (not pods directly)
          kubectl rollout status statefulset/mongodb-auth -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Auth MongoDB timeout, continuing..." }
          
          kubectl rollout status statefulset/mongodb-restaurant -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Restaurant MongoDB timeout, continuing..." }
          
          kubectl rollout status statefulset/mongodb-order -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Order MongoDB timeout, continuing..." }
          
          kubectl rollout status statefulset/mongodb-payment -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Payment MongoDB timeout, continuing..." }
          
          echo "MongoDB deployment completed!"
        continue-on-error: true

      - name: Deploy Backend Microservices
        run: |
          # Clean up existing services first
          kubectl delete -f infra/k8s/auth-service-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/restaurant-service-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/order-service-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/payment-service-deployment.yaml --ignore-not-found=true
          
          echo "Waiting for old services to be cleaned up..."
          Start-Sleep -Seconds 10

          # Deploy new backend services
          kubectl apply -f infra/k8s/auth-service-deployment.yaml
          kubectl apply -f infra/k8s/auth-service-service.yaml
          kubectl apply -f infra/k8s/restaurant-service-deployment.yaml
          kubectl apply -f infra/k8s/restaurant-service-service.yaml
          kubectl apply -f infra/k8s/order-service-deployment.yaml
          kubectl apply -f infra/k8s/order-service-service.yaml
          kubectl apply -f infra/k8s/payment-service-deployment.yaml
          kubectl apply -f infra/k8s/payment-service-service.yaml

      - name: Deploy Frontend Apps
        run: |
          # Clean up existing frontends
          kubectl delete -f infra/k8s/client-frontend-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/admin-frontend-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/restaurant-frontend-deployment.yaml --ignore-not-found=true
          
          echo "Waiting for old frontends to be cleaned up..."
          Start-Sleep -Seconds 10
          
          # Deploy new frontends
          kubectl apply -f infra/k8s/client-frontend-deployment.yaml
          kubectl apply -f infra/k8s/client-frontend-service.yaml
          kubectl apply -f infra/k8s/admin-frontend-deployment.yaml
          kubectl apply -f infra/k8s/admin-frontend-service.yaml
          kubectl apply -f infra/k8s/restaurant-frontend-deployment.yaml
          kubectl apply -f infra/k8s/restaurant-frontend-service.yaml

      - name: Deploy Nginx Gateway
        run: |
          kubectl apply -f infra/k8s/nginx-configmap.yaml
          kubectl apply -f infra/k8s/nginx-deployment.yaml
          kubectl apply -f infra/k8s/nginx-service.yaml

      - name: Wait for deployments to be ready
        run: |
          echo "Waiting for services to be ready (this may take 2-3 minutes)..."
          
          kubectl rollout status deployment/auth-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Auth service timeout" }
          
          kubectl rollout status deployment/restaurant-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Restaurant service timeout" }
          
          kubectl rollout status deployment/order-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Order service timeout" }
          
          kubectl rollout status deployment/payment-service -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Payment service timeout" }
          
          kubectl rollout status deployment/client-frontend -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Client frontend timeout" }
          
          kubectl rollout status deployment/admin-frontend -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Admin frontend timeout" }
          
          kubectl rollout status deployment/restaurant-frontend -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Restaurant frontend timeout" }
          
          kubectl rollout status deployment/nginx-gateway -n cnpm-food-delivery --timeout=5m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Nginx timeout" }
          
          echo "Deployment rollout completed!"
        continue-on-error: true

      # 5️⃣ Deploy Monitoring Stack (Optional)
      - name: Deploy Monitoring Stack
        run: |
          echo "Deploying Prometheus, Grafana, and Loki..."
          
          # Deploy Prometheus
          kubectl apply -f infra/k8s/monitoring/prometheus.yaml
          
          # Deploy Grafana
          kubectl apply -f infra/k8s/monitoring/grafana.yaml
          
          # Deploy Loki & Promtail
          kubectl apply -f infra/k8s/monitoring/loki.yaml
          
          echo "Waiting for monitoring stack to be ready..."
          Start-Sleep -Seconds 20
          
          kubectl rollout status deployment/prometheus -n cnpm-food-delivery --timeout=3m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Prometheus timeout" }
          
          kubectl rollout status deployment/grafana -n cnpm-food-delivery --timeout=3m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Grafana timeout" }
          
          kubectl rollout status deployment/loki -n cnpm-food-delivery --timeout=3m
          if ($LASTEXITCODE -ne 0) { echo "Warning: Loki timeout" }
          
          echo "Monitoring stack deployed!"
        continue-on-error: true

      # 6️⃣ Verify deployment
      - name: Verify Deployment
        run: |
          echo "=== All Pods (App + Monitoring) ==="
          kubectl get pods -n cnpm-food-delivery
          echo ""
          echo "=== All Services (App + Monitoring) ==="
          kubectl get svc -n cnpm-food-delivery
          echo ""
          echo "=== All Deployments ==="
          kubectl get deployments -n cnpm-food-delivery
          echo ""
          echo "=== Access URLs ==="
          echo "Application: kubectl port-forward -n cnpm-food-delivery svc/nginx-gateway 8080:80"
          echo "  Then: http://localhost:8080"
          echo ""
          echo "Grafana: kubectl port-forward -n cnpm-food-delivery svc/grafana 3000:3000"
          echo "  Then: http://localhost:3000 (admin/admin123)"
          echo ""
          echo "Prometheus: kubectl port-forward -n cnpm-food-delivery svc/prometheus 9090:9090"
          echo "  Then: http://localhost:9090"
