name: CI/CD Pipeline - Docker Desktop K8s

on:
  push:
    branches:
      - main
      - source
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'infra/k8s/**'
      - '.github/workflows/deploy-k8s.yml'
  workflow_dispatch:  # Cho phép trigger manual

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Chạy trên máy local với Docker Desktop

    steps:
      - name: Clean temp directory
        shell: powershell
        run: |
          if (Test-Path "$env:RUNNER_TEMP") {
            Get-ChildItem -Path "$env:RUNNER_TEMP" -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          $workDir = "E:\GitHub\actions-runner\_work\_temp"
          if (Test-Path $workDir) {
            Get-ChildItem -Path $workDir -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
          echo "✓ Temp cleanup completed"
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@v3

      # 1️⃣ Đăng nhập vào DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2️⃣ Build & push Backend Services
      - name: Build and Push Auth Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/auth-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/auth-service:latest

      - name: Build and Push Restaurant Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/restaurant-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/restaurant-service:latest

      - name: Build and Push Order Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/order-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/order-service:latest

      - name: Build and Push Payment Service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/payment-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/payment-service:latest

      # 2️⃣ Build & push Frontend Apps
      - name: Build and Push Client Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/client
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/client-frontend:latest

      - name: Build and Push Admin Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/admin
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/admin-frontend:latest

      - name: Build and Push Restaurant Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/restaurant
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/restaurant-frontend:latest

      # 3️⃣ Verify Docker Desktop Kubernetes
      - name: Check Kubernetes context
        run: |
          kubectl config current-context
          kubectl cluster-info
          kubectl get nodes

      # 4️⃣ Deploy to Docker Desktop Kubernetes
      - name: Prepare Namespace and Base Resources
        run: |
          # Create namespace if not exists
          kubectl create namespace cnpm-food-delivery --dry-run=client -o yaml | kubectl apply -f -
          
          # Apply base resources
          kubectl apply -f infra/k8s/namespace.yaml
          kubectl apply -f infra/k8s/secrets.yaml
          kubectl apply -f infra/k8s/pvcs.yaml

      - name: Deploy MongoDB Services
        run: |
          # Clean up existing MongoDB if exists
          kubectl delete -f infra/k8s/auth-service-mongo.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/restaurant-service-mongo.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/order-service-mongo.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/payment-service-mongo.yaml --ignore-not-found=true
          
          Start-Sleep -Seconds 10
          
          # Deploy MongoDB instances
          kubectl apply -f infra/k8s/auth-service-mongo.yaml
          kubectl apply -f infra/k8s/restaurant-service-mongo.yaml
          kubectl apply -f infra/k8s/order-service-mongo.yaml
          kubectl apply -f infra/k8s/payment-service-mongo.yaml
          
          echo "Waiting for MongoDB instances to be ready..."
          kubectl wait --for=condition=ready pod -l app=auth-mongo -n cnpm-food-delivery --timeout=300s; if (!$?) { echo "Auth MongoDB timeout" }
          kubectl wait --for=condition=ready pod -l app=restaurant-mongo -n cnpm-food-delivery --timeout=300s; if (!$?) { echo "Restaurant MongoDB timeout" }
          kubectl wait --for=condition=ready pod -l app=order-mongo -n cnpm-food-delivery --timeout=300s; if (!$?) { echo "Order MongoDB timeout" }
          kubectl wait --for=condition=ready pod -l app=payment-mongo -n cnpm-food-delivery --timeout=300s; if (!$?) { echo "Payment MongoDB timeout" }

      - name: Deploy Backend Microservices
        run: |
          # Clean up existing services first
          kubectl delete -f infra/k8s/auth-service-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/restaurant-service-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/order-service-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/payment-service-deployment.yaml --ignore-not-found=true
          
          echo "Waiting for old services to be cleaned up..."
          Start-Sleep -Seconds 10

          # Deploy new backend services
          kubectl apply -f infra/k8s/auth-service-deployment.yaml
          kubectl apply -f infra/k8s/auth-service-service.yaml
          kubectl apply -f infra/k8s/restaurant-service-deployment.yaml
          kubectl apply -f infra/k8s/restaurant-service-service.yaml
          kubectl apply -f infra/k8s/order-service-deployment.yaml
          kubectl apply -f infra/k8s/order-service-service.yaml
          kubectl apply -f infra/k8s/payment-service-deployment.yaml
          kubectl apply -f infra/k8s/payment-service-service.yaml

      - name: Deploy Frontend Apps
        run: |
          # Clean up existing frontends
          kubectl delete -f infra/k8s/client-frontend-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/admin-frontend-deployment.yaml --ignore-not-found=true
          kubectl delete -f infra/k8s/restaurant-frontend-deployment.yaml --ignore-not-found=true
          
          echo "Waiting for old frontends to be cleaned up..."
          Start-Sleep -Seconds 10
          
          # Deploy new frontends
          kubectl apply -f infra/k8s/client-frontend-deployment.yaml
          kubectl apply -f infra/k8s/client-frontend-service.yaml
          kubectl apply -f infra/k8s/admin-frontend-deployment.yaml
          kubectl apply -f infra/k8s/admin-frontend-service.yaml
          kubectl apply -f infra/k8s/restaurant-frontend-deployment.yaml
          kubectl apply -f infra/k8s/restaurant-frontend-service.yaml

      - name: Deploy Nginx Gateway
        run: |
          kubectl apply -f infra/k8s/nginx-configmap.yaml
          kubectl apply -f infra/k8s/nginx-deployment.yaml
          kubectl apply -f infra/k8s/nginx-service.yaml

      - name: Wait for deployments to be ready
        run: |
          echo "Waiting for services to be ready (this may take 2-3 minutes)..."
          kubectl rollout status deployment/auth-service -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Auth service timeout" }
          kubectl rollout status deployment/restaurant-service -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Restaurant service timeout" }
          kubectl rollout status deployment/order-service -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Order service timeout" }
          kubectl rollout status deployment/payment-service -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Payment service timeout" }
          kubectl rollout status deployment/client-frontend -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Client frontend timeout" }
          kubectl rollout status deployment/admin-frontend -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Admin frontend timeout" }
          kubectl rollout status deployment/restaurant-frontend -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Restaurant frontend timeout" }
          kubectl rollout status deployment/nginx-gateway -n cnpm-food-delivery --timeout=5m; if (!$?) { echo "Nginx timeout" }

      # 5️⃣ Verify deployment
      - name: Verify Deployment
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n cnpm-food-delivery
          echo ""
          echo "=== Services ==="
          kubectl get svc -n cnpm-food-delivery
          echo ""
          echo "=== Deployment Summary ==="
          kubectl get deployments -n cnpm-food-delivery
          echo ""
          echo "=== Access URLs ==="
          echo "Run: kubectl port-forward -n cnpm-food-delivery svc/nginx-gateway 8080:80"
          echo "Then access: http://localhost:8080"
